<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="毕业论文," />










<meta name="description" content="1. 绪论1.1 研究目的区块链源自于比特币，而比特币被认为是一种去中心化，非普遍全球可支付的电子加密货币。从本质上讲，区块链技术，是一种交易记录的存储技术，它对交易记录进行永久性存储，而且存储之后永远无法删除，只能按照次序加入新的交易，由此对所有的交易历史进行永不结束的记载。这个看似简单的功能描述，实则含义深刻。它促使我们重新思考如何去创建交易、存储数据和交换资产，更重要的是，它将有机会彻底重塑">
<meta name="keywords" content="毕业论文">
<meta property="og:type" content="article">
<meta property="og:title" content="基于区块链的菜谱发布网站的设计和实现（Nebulas星云链）">
<meta property="og:url" content="http://zyqvizzz.github.io/星云链/index.html">
<meta property="og:site_name" content="百晓生的兵器谱">
<meta property="og:description" content="1. 绪论1.1 研究目的区块链源自于比特币，而比特币被认为是一种去中心化，非普遍全球可支付的电子加密货币。从本质上讲，区块链技术，是一种交易记录的存储技术，它对交易记录进行永久性存储，而且存储之后永远无法删除，只能按照次序加入新的交易，由此对所有的交易历史进行永不结束的记载。这个看似简单的功能描述，实则含义深刻。它促使我们重新思考如何去创建交易、存储数据和交换资产，更重要的是，它将有机会彻底重塑">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-e4b6edf69cc3bba8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-5196ff30279448fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-27a672563348bead.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-d2ba74c1d696a17d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-74e9c8796bcc7a75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-0d3fd90bdbcd2393.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-6451ec8a60de4474.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-69a145c9e6fa0edf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-e06ea2b14a03811d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/3396508-7753d550da9192d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://vitalik.ca/files/Lamport.png">
<meta property="og:image" content="http://vitalik.ca/files/Lamport2.png">
<meta property="og:image" content="http://vitalik.ca/files/Lamport3.png">
<meta property="og:image" content="http://vitalik.ca/files/Lamport.png">
<meta property="og:image" content="https://res.infoq.com/articles/vitalik-buterin-proposes-consensus-algorithm/zh/resources/6272-1535217006997.png">
<meta property="og:image" content="https://res.infoq.com/articles/vitalik-buterin-proposes-consensus-algorithm/zh/resources/5173-1535217007241.png">
<meta property="og:updated_time" content="2018-09-05T08:20:27.501Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于区块链的菜谱发布网站的设计和实现（Nebulas星云链）">
<meta name="twitter:description" content="1. 绪论1.1 研究目的区块链源自于比特币，而比特币被认为是一种去中心化，非普遍全球可支付的电子加密货币。从本质上讲，区块链技术，是一种交易记录的存储技术，它对交易记录进行永久性存储，而且存储之后永远无法删除，只能按照次序加入新的交易，由此对所有的交易历史进行永不结束的记载。这个看似简单的功能描述，实则含义深刻。它促使我们重新思考如何去创建交易、存储数据和交换资产，更重要的是，它将有机会彻底重塑">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/3396508-e4b6edf69cc3bba8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: 'UQ916D0T6S',
      apiKey: 'c2eecdbced58726dccb6cad90d7b6ab4',
      indexName: 'BAIXS',
      hits: {"per_page":10},
      labels: {"input_placeholder":"请输入关键字","hits_empty":"未收录: ${query}","hits_stats":"${hits}条结果，用时${time} 毫秒"}
    }
  };
</script>



  <link rel="canonical" href="http://zyqvizzz.github.io/星云链/"/>





  <title>基于区块链的菜谱发布网站的设计和实现（Nebulas星云链） | 百晓生的兵器谱</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">百晓生的兵器谱</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">BAIXS's BOOK</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-noval">
          <a href="/noval" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-book"></i> <br />
            
            简历
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  
  <div class="algolia-popup popup search-popup">
    <div class="algolia-search">
      <div class="algolia-search-input-icon">
        <i class="fa fa-search"></i>
      </div>
      <div class="algolia-search-input" id="algolia-search-input"></div>
    </div>

    <div class="algolia-results">
      <div id="algolia-stats"></div>
      <div id="algolia-hits"></div>
      <div id="algolia-pagination" class="algolia-pagination"></div>
    </div>

    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
  </div>




    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://zyqvizzz.github.io/星云链/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="断桥百晓生">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/012.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="百晓生的兵器谱">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">基于区块链的菜谱发布网站的设计和实现（Nebulas星云链）</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-05T13:18:09+08:00">
                2018-09-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/区块链/" itemprop="url" rel="index">
                    <span itemprop="name">区块链</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="1-绪论"><a href="#1-绪论" class="headerlink" title="1. 绪论"></a>1. 绪论</h2><h3 id="1-1-研究目的"><a href="#1-1-研究目的" class="headerlink" title="1.1 研究目的"></a>1.1 研究目的</h3><p>区块链源自于比特币，而比特币被认为是一种去中心化，非普遍全球可支付的电子加密货币。从本质上讲，区块链技术，是一种交易记录的存储技术，它对交易记录进行永久性存储，而且存储之后永远无法删除，只能按照次序加入新的交易，由此对所有的交易历史进行永不结束的记载。这个看似简单的功能描述，实则含义深刻。它促使我们重新思考如何去创建交易、存储数据和交换资产，更重要的是，它将有机会彻底重塑当今社会的信任机制和价值体系。</p>
<a id="more"></a>
<p>技术的革新瞬息万变，区块链技术在历经8年的考验后终于站在了风口之上，2017年底，各种令人眼花缭乱的区块链项目，如同雨后春笋一般走进了我们的视野，其涉及到的应用场景种类繁杂，包括游戏，金融，支付，存储，物联网等等。但是由于区块链扩容难，速率慢且易拥堵，以及共识算法不完善等难题尚未被完全攻克，至今仍未有一个真正可以大规模落地的区块链应用出现。</p>
<p>我们站在时代的前沿，自然不能够故步自封，尽管这项技术至今还处在起步阶段，但我们仍然有足够的理由和热情去拥抱这项颠覆性的技术，所以在几个公链项目里如eos、eth、zilliqa和nas中进行了学习和甄选之后，我选择了由前蚂蚁金服区块链团队出品的星云链作为这次研究的对象。</p>
<h3 id="1-2-发展历程"><a href="#1-2-发展历程" class="headerlink" title="1.2 发展历程"></a>1.2 发展历程</h3><p>星云链（NAS）团队在2017年组成，并于2018年3月29日发布主网，是一套基于以太坊构建一个能够量化价值尺度、具备自进化能力，并能促进区块链生态建设的区块链系统，号称为”区块链中的搜索引擎”和”下一个谷歌”。</p>
<p>星云链的共识算法为POD（proof-of-devotion），即贡献度证明算法。贡献度证明算法本质上是对于在星云链上创造价值（比如 DApp ）的开发者进行奖励。如果你开发了一个 DApp 并且在星云链的网络上表现良好，你可以选择成为一个验证者（比如：验证一笔提交的交易），然后，作为回报，你会收到星云链发给你的代币奖励。该算法理论上可以实现一套可行的共识体系，但是“哲人王”式的共识体系使大部分代币持有者失去记账权，把信任建立在了技术水平上的做法并不能解除中心化的风险，它依然存在较大的争议。</p>
<p>星云链上其他内容有星云指数和星云原力。星云指数(Nebulas Rank)用于构建价值尺度：星云指数通过对星云链上产生的行为进行挖掘分析，将每个实体的重要程度进行量化。将区块链的维度提升到了三维，用它来衡量区块链世界的价值尺度，这样就可以对区块链里的应用进行分级评价，让优秀的应用浮现出来。而星云原力(Nebulas Force)则是自进化的区块链技术：目前的区块链项目的核心协议基本都是不支持升级的，包括智能合约，一经部署，就无法再升级。其中潜在的危害无疑是巨大的。对于这个问题，星云链提出了星云原力，一个区块链自进化的机智，用来对核心协议，智能合约进行升级和修复。在星云链中，代币持有者可以通过投票来达到升级智能合约的目的，如果大多数投票通过，那么 bug 就可以随时被修复。</p>
<p>星云链以DApp为核心概念，较之于同样以DApp为核心的航母级项目eos.io，它特有星云指数和星云原力对于普通开发者要更加友好。尽管和目前的每个公链项目一样，它自身仍然有众多瑕疵和不确定性，但对于入门DApp开发、理解智能合约来说，它是当仁不让的首选。</p>
<h3 id="1-3-开发工具的选择"><a href="#1-3-开发工具的选择" class="headerlink" title="1.3 开发工具的选择"></a>1.3 开发工具的选择</h3><h4 id="1-3-1-IDE选择"><a href="#1-3-1-IDE选择" class="headerlink" title="1.3.1 IDE选择"></a>1.3.1 IDE选择</h4><p>由于星云链为开发者提供了一套简单的JS-SDK，智能合约可以完全由JS编写，所以我选择了WebStorm作为本项目的开发工具。</p>
<h4 id="1-3-2-操作系统选择"><a href="#1-3-2-操作系统选择" class="headerlink" title="1.3.2 操作系统选择"></a>1.3.2 操作系统选择</h4><p>MacOS high Sierra。运行星云网络需要在Golang环境下运行，MacOS配置复杂的环境要比Windows更加简单，避免不必要的错误和麻烦。</p>
<h4 id="1-3-3-Web容器选择"><a href="#1-3-3-Web容器选择" class="headerlink" title="1.3.3 Web容器选择"></a>1.3.3 Web容器选择</h4><p>基于区块链的DApp项目不需要服务端支持，智能合约将取代服务端所具备的功能，部署在星云链主网。</p>
<h4 id="1-3-4-数据库"><a href="#1-3-4-数据库" class="headerlink" title="1.3.4 数据库"></a>1.3.4 数据库</h4><p>本地数据存储在Chrome浏览器提供的Web SQL 数据库中，远程数据存储在区块链中。</p>
<h4 id="1-3-5-编程框架"><a href="#1-3-5-编程框架" class="headerlink" title="1.3.5 编程框架"></a>1.3.5 编程框架</h4><p>前端使用JQuery开发，智能合约使用原生Javascript编写。前端及智能合约皆遵循ECMAScript5的标准编写。</p>
<h2 id="2-系统分析"><a href="#2-系统分析" class="headerlink" title="2. 系统分析"></a>2. 系统分析</h2><h3 id="2-1-主要功能"><a href="#2-1-主要功能" class="headerlink" title="2.1 主要功能"></a>2.1 主要功能</h3><ol>
<li>查看最热菜谱，该菜谱列表由点赞最多的菜谱组成；</li>
<li>查看所有菜谱，在这里可以按需找到任何想要的菜谱；</li>
<li>点击菜谱图片，可以查看菜谱的具体做法和步骤；</li>
<li>通过搜索功能，快速找到自己想要的菜谱；</li>
<li>按步骤录入并分享自己的菜谱；</li>
<li>点赞或打赏，打赏星云币，使用该功能必须下载浏览器钱包插件。</li>
</ol>
<h3 id="2-2-方案论证"><a href="#2-2-方案论证" class="headerlink" title="2.2 方案论证"></a>2.2 方案论证</h3><ol>
<li>网站界面：美食网站首先要考虑到的是食欲，所以界面将以干净和温暖的色调为主，通过简洁的界面，让用户感受到舒适的气氛。</li>
<li>功能实现：由于目前关于DApp开发的资料及其稀少，星云网络也处于非常早期的阶段，所以本项目将实现一些最基本的功能：单个菜谱的新增、修改、查看，过滤获取数据资源，以及最主要的星云币打赏交易。</li>
</ol>
<h3 id="2-3-基本思路"><a href="#2-3-基本思路" class="headerlink" title="2.3 基本思路"></a>2.3 基本思路</h3><h4 id="2-3-1-网站UI的思路"><a href="#2-3-1-网站UI的思路" class="headerlink" title="2.3.1 网站UI的思路"></a>2.3.1 网站UI的思路</h4><p>UI，对于设计者来说，可以算是最简单的地方；但对于用户一个良好的用户界面非常重要，普通用户根本不会关心你的界面时怎么实现的，他所关心的是UI是否美丽、大方、好看。如果一个网站的UI不好看，可能用户根本没有用下去的心思了。本网站使用Bootstrap作为UI框架，简单优美。</p>
<h4 id="2-3-2-获取数据的思路"><a href="#2-3-2-获取数据的思路" class="headerlink" title="2.3.2 获取数据的思路"></a>2.3.2 获取数据的思路</h4><p>所有数据均来自于Nebulas星云链，制定合适的抓取策略，获得所需要的资源。</p>
<h4 id="2-3-3-权限控制思路"><a href="#2-3-3-权限控制思路" class="headerlink" title="2.3.3 权限控制思路"></a>2.3.3 权限控制思路</h4><p>本应用的角色不存在多重权限，因为应用定位为菜谱分享网站，而不可篡改、不可回滚和可溯源则是区块链建立的初衷。所以它不需要一个特定的管理员去进行中心化的操作，那如何防止用户上传垃圾信息呢？解决方法是提高用户的上传成本，用户每上传一条信息，都需要向星云网络支付一定数额的星云币，这就在一定程度上保证了垃圾信息不会泛滥。但是当真正出现垃圾信息需要被清理的需求时，我们在星云网络上则有另一套更新策略，目前这一套dapp更新策略在整个区块链行业中尚不拥有一个真正完美的解决方案，所以在此不予讨论。把星云链钱包插件绑定在应用上，则钱包地址将成为标识身份的唯一ID，用户可以在发布菜谱的时候填写个人信息，如昵称等，它们不会跟着真正的数据一起上链，但是钱包地址将作为一个钩子获取到它们。</p>
<h3 id="2-4-主要问题"><a href="#2-4-主要问题" class="headerlink" title="2.4 主要问题"></a>2.4 主要问题</h3><p>该应用最主要的问题是更新和迭代，这也是目前所有dapp面临的问题，每次更新就意味着要把智能合约替换，而替换智能合约，就相当于弃用了旧的服务器，所有数据将从零开始。</p>
<h3 id="2-5-网站要求"><a href="#2-5-网站要求" class="headerlink" title="2.5 网站要求"></a>2.5 网站要求</h3><p>适配绝大部分IE9以上浏览器和移动端浏览器，有较快的响应速度，并且有合理的错误提示和404页面。</p>
<h2 id="3-系统设计"><a href="#3-系统设计" class="headerlink" title="3 系统设计"></a>3 系统设计</h2><h3 id="3-1-概要设计"><a href="#3-1-概要设计" class="headerlink" title="3.1 概要设计"></a>3.1 概要设计</h3><h4 id="3-1-1-系统结构图"><a href="#3-1-1-系统结构图" class="headerlink" title="3.1.1 系统结构图"></a>3.1.1 系统结构图</h4><p>针对上面的需求分析，我们把整个系统分成三个模块：1、Model：实现数据抓取，数据处理等功能。2、View：实现网站的界面布局和接收用户响应。3、ViewModel：用来接收view层的响应，处理业务逻辑，并转发给model层。</p>
<p>系统结构图如图所示：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-e4b6edf69cc3bba8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h4 id="3-1-2-数据表结构图"><a href="#3-1-2-数据表结构图" class="headerlink" title="3.1.2  数据表结构图"></a>3.1.2  数据表结构图</h4><p>系统包含三个表，美食表，用户表和评论表.</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-5196ff30279448fd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="4-系统实现"><a href="#4-系统实现" class="headerlink" title="4 系统实现"></a>4 系统实现</h2><h3 id="4-1-创建系统外观界面"><a href="#4-1-创建系统外观界面" class="headerlink" title="4.1 创建系统外观界面"></a>4.1 创建系统外观界面</h3><p>根据网站的需要设计网页，主要分为首页、注册、登陆、分类等界面，有公共的头部和尾部。用Html+Css+Bootstrap实现。</p>
<p><strong>头部代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;header class=&quot;header_zi&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;container&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;logo&quot;&gt;</span><br><span class="line">        &lt;a href=&quot;index.html&quot;&gt;&lt;img src=&quot;images/logo1.png&quot;/&gt;&lt;/a&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;a href=&quot;#mmenu&quot; class=&quot;phone-nav&quot;&gt;&lt;i class=&quot;fa fa-list&quot;&gt;&lt;/i&gt;&lt;/a&gt;</span><br><span class="line">      &lt;div class=&quot;logo_right&quot;&gt;</span><br><span class="line">        &lt;nav class=&quot;nav&quot;&gt;</span><br><span class="line">          &lt;ul&gt;</span><br><span class="line">            li...</span><br><span class="line">          &lt;/ul&gt;</span><br><span class="line">        &lt;/nav&gt;</span><br><span class="line">        &lt;div class=&quot;search&quot;&gt;</span><br><span class="line">		  	 	&lt;span class=&quot;sea_x&quot;&gt;</span><br><span class="line">		  	 		&lt;input id=&quot;search_input&quot; placeholder=&quot;请输入关键词&quot;&gt;</span><br><span class="line">		  	 		&lt;i class=&quot;fa fa-search&quot; id=&quot;searchByKey&quot;&gt;&lt;/i&gt;		  	</span><br><span class="line">		  	 	&lt;/span&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">  &lt;/header&gt;</span><br></pre></td></tr></table></figure>
<p><strong>尾部代码</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;footer class=&quot;footer&quot;&gt;</span><br><span class="line">    &lt;div class=&quot;footer_con&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;con&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;nei&quot;&gt;</span><br><span class="line">          &lt;div&gt;</span><br><span class="line">            &lt;ul class=&quot;di_nav clearfix&quot;&gt;</span><br><span class="line">              li...</span><br><span class="line">            &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;clear&quot;&gt;&lt;/div&gt;</span><br><span class="line">          &lt;div class=&quot;lian&quot;&gt;</span><br><span class="line">            text...</span><br><span class="line">          &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;div class=&quot;copy&quot;&gt;text...&lt;/div&gt;</span><br><span class="line">  &lt;/footer&gt;</span><br></pre></td></tr></table></figure>
<h3 id="4-2-构建一个事件模型"><a href="#4-2-构建一个事件模型" class="headerlink" title="4.2 构建一个事件模型"></a>4.2 构建一个事件模型</h3><p>定义转换接口，界面端调用js_back中的函数，均通过这里做转换，采用监听发送的方式进行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 构造函数</span><br><span class="line"></span><br><span class="line">var TranslateObj = function() &#123;</span><br><span class="line">    this.kitObj = new FoodShare();</span><br><span class="line">    this.kitObj.init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// 事件监听器</span><br><span class="line"></span><br><span class="line">TranslateObj.prototype = &#123;</span><br><span class="line">	···</span><br><span class="line">	addListenerFromUI: function() &#123;</span><br><span class="line">        var self = this;</span><br><span class="line">        window.addEventListener(&apos;message&apos;, function(e) &#123;</span><br><span class="line"></span><br><span class="line">            if(e.data.target === &quot;contentscript_j&quot;) &#123;</span><br><span class="line">                // 收到发送过来的请求</span><br><span class="line">                var method_type = e.data.method;</span><br><span class="line">                var call_data = e.data.data;</span><br><span class="line">                if(call_data == null ) &#123;</span><br><span class="line">                    console.log(&quot;error , no input data object&quot;);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                if (call_data.contract == null) &#123;</span><br><span class="line">                    console.log(&quot;error, no contract data object&quot;);</span><br><span class="line">                    return;</span><br><span class="line">                &#125;</span><br><span class="line">                var func_name = call_data.contract.function;</span><br><span class="line">                // 传入参数是一个数组，每个位放置一个参数</span><br><span class="line">                var arg_list_s = call_data.contract.args;</span><br><span class="line">                var arg_list = [];</span><br><span class="line">                if (arg_list_s != &quot;&quot;) &#123;</span><br><span class="line">                    arg_list = JSON.parse(arg_list_s);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if(method_type == &quot;neb_call&quot;) &#123;</span><br><span class="line">                    // 查看</span><br><span class="line">                    self.doNebCallFun(func_name, arg_list);</span><br><span class="line">                &#125; else if(method_type == &quot;neb_sendTransaction&quot;) &#123;</span><br><span class="line">                    // 修改和新增</span><br><span class="line">                    self.doSendTransaction(func_name, arg_list);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">	···</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中self.doNebCallFun和self.doSendTransaction分别为拦截ViewModel层的函数调用并转换和发送转换后的结果。</p>
<h3 id="4-3-智能合约的实现"><a href="#4-3-智能合约的实现" class="headerlink" title="4.3 智能合约的实现"></a>4.3 智能合约的实现</h3><p>在智能合约中，首先要构建三个模型：FoodInfo（美食），Comment（评论）和Good（点赞）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// 以FoodInfo为例</span><br><span class="line"></span><br><span class="line">var FoodInfoItem = function(text) &#123;</span><br><span class="line">	if (text) &#123;</span><br><span class="line">        var obj = JSON.parse(text);</span><br><span class="line">        this.name = obj.name; // 发布者名称</span><br><span class="line">        this.food_type = obj.food_type; // 菜系</span><br><span class="line">        this.food_name = obj.food_name;// 菜品名称</span><br><span class="line">        this.food_summary = obj.food_summary;// 难易程度</span><br><span class="line">        this.image = obj.image;//图片</span><br><span class="line">        this.main_mat = obj.main_mat;// 主料</span><br><span class="line">		this.sub_mat = obj.sub_mat;// 辅料(JSON串)</span><br><span class="line">		this.cook_book = obj.cook_book;//菜谱详情</span><br><span class="line">        this.time = obj.time;//记录时间</span><br><span class="line">		this.like_num = obj.like_num;//点赞数</span><br><span class="line">		this.comm_num = obj.comm_num;//评论数</span><br><span class="line">        this.from = obj.from;</span><br><span class="line">        this.food_info_key = obj.food_info_key;</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">	    this.name = &quot;&quot;;</span><br><span class="line">        this.food_type = &quot;&quot;;</span><br><span class="line">        this.food_name = &quot;&quot;;</span><br><span class="line">        this.food_summary=&quot;&quot;;</span><br><span class="line">		this.image=&quot;&quot;;</span><br><span class="line">		this.sub_mat=&quot;&quot;;</span><br><span class="line">		this.main_mat=&quot;&quot;;</span><br><span class="line">		this.cook_book=&quot;&quot;;</span><br><span class="line">		this.time =&quot;&quot;;</span><br><span class="line">		this.like_num =0;</span><br><span class="line">		this.comm_num =0;</span><br><span class="line">        this.from = &quot;&quot;;</span><br><span class="line">        this.food_info_key = &quot;&quot;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第二步是要构建数据结构和存储容器：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// 以FoodInfo为例</span><br><span class="line"></span><br><span class="line">var FoodShare = function() &#123;</span><br><span class="line">    // 1. 先创建GoldSunStorage对象（用于存储数据）</span><br><span class="line">    // 2. 定义数据结构，该行代码作用：为ApiSample创建一个属性sample_data，该属性是一个list结构，list中存储的是SampleDataItem对象</span><br><span class="line">    LocalContractStorage.defineMapProperty(this, &quot;food_info_list&quot;, &#123;</span><br><span class="line">        parse: function (text) &#123;</span><br><span class="line">            return new FoodInfoItem(text);</span><br><span class="line">        &#125;,</span><br><span class="line">        stringify: function (o) &#123;</span><br><span class="line">            return o.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    LocalContractStorage.defineProperty(this, &quot;food_info_list_size&quot;);</span><br><span class="line">    // 定义一个存储string的list</span><br><span class="line">    LocalContractStorage.defineMapProperty(this, &quot;food_info_list_array&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第三步是编写方法，实现如添加，查询，分页等功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br></pre></td><td class="code"><pre><span class="line">// 以FoodInfo为例</span><br><span class="line"></span><br><span class="line">FoodShare.prototype = &#123;</span><br><span class="line">    // 初始化方法，在使用ApiSample之前，务必要调用一次(而且只能调用一次)，所有的初始化逻辑都放到这里</span><br><span class="line">    init: function() &#123;</span><br><span class="line">        if (this.food_info_list_size == null) &#123;</span><br><span class="line">            this.food_info_list_size = 0;</span><br><span class="line">        &#125;</span><br><span class="line">		if (this.comment_item_list_size == null) &#123;</span><br><span class="line">            this.comment_item_list_size = 0;</span><br><span class="line">        &#125;</span><br><span class="line">        if (this.good_item_list_size == null) &#123;</span><br><span class="line">            this.good_item_list_size = 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    </span><br><span class="line">    // 添加一个对象到list中</span><br><span class="line">    add_food_info_to_list: function(text) &#123;</span><br><span class="line">        var addResult = &#123;</span><br><span class="line">            success : false,</span><br><span class="line">            message : &quot;&quot;</span><br><span class="line">        &#125;;</span><br><span class="line">        var obj = text;</span><br><span class="line">        obj.from = Blockchain.transaction.from;</span><br><span class="line">        var result = this.query_foodinfo_by_key(obj.from+&quot;_&quot;+obj.time_stamp);</span><br><span class="line">        if(result.success)&#123;</span><br><span class="line">            addResult.success = false;</span><br><span class="line">            addResult.message = &quot;You have added a food!&quot;;</span><br><span class="line">            return addResult;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">			obj.name = obj.name.trim();//名称</span><br><span class="line">			obj.food_type = obj.food_type.trim();//地址</span><br><span class="line">			obj.food_name = obj.food_name.trim();</span><br><span class="line">			obj.food_summary = obj.food_summary.trim();</span><br><span class="line">			obj.image = obj.image.trim();//图片</span><br><span class="line">			obj.sub_mat = obj.sub_mat.trim();//费用</span><br><span class="line">			obj.main_mat = obj.main_mat.trim();</span><br><span class="line">			obj.cook_book = obj.cook_book.trim();//攻略正文</span><br><span class="line">			obj.time = obj.time.trim();//记录时间</span><br><span class="line">			obj.from = obj.from.trim();</span><br><span class="line">            </span><br><span class="line">            if(obj.name===&quot;&quot;|| obj.food_type===&quot;&quot;||obj.food_name===&quot;&quot; || obj.cook_book === &quot;&quot; || obj.image == &quot;&quot;)&#123;</span><br><span class="line">                addResult.success = false;</span><br><span class="line">                addResult.message = &quot;empty name / food_type / food_name / text / image&quot;;</span><br><span class="line">                return addResult;</span><br><span class="line">            &#125;</span><br><span class="line">            var food_item = new FoodInfoItem();</span><br><span class="line">            food_item.name = obj.name;</span><br><span class="line">            food_item.food_type = obj.food_type;</span><br><span class="line">            food_item.food_summary = obj.food_summary;</span><br><span class="line">            food_item.sub_mat = obj.sub_mat;</span><br><span class="line">            food_item.main_mat = obj.main_mat;</span><br><span class="line">            food_item.food_name = obj.food_name;</span><br><span class="line">            food_item.cook_book = obj.cook_book;</span><br><span class="line">            food_item.image = obj.image;</span><br><span class="line">            food_item.time = obj.time;</span><br><span class="line">            food_item.from = obj.from;</span><br><span class="line">            food_item.food_info_key = food_item.from+&quot;_&quot;+ obj.time_stamp;</span><br><span class="line">            var index = this.food_info_list_size;</span><br><span class="line">            this.food_info_list_array.put(index,food_item.from+&quot;_&quot;+obj.time_stamp);</span><br><span class="line">            this.food_info_list.put(food_item.from+&quot;_&quot;+obj.time_stamp, food_item);</span><br><span class="line">            this.food_info_list_size +=1;</span><br><span class="line">            addResult.success = true;</span><br><span class="line">            addResult.message = &quot;You successfully added a food!&quot;;</span><br><span class="line">            return addResult;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 获取最热美食</span><br><span class="line">    query_hot_food_list: function(hot_num) &#123;</span><br><span class="line">        var result = &#123;</span><br><span class="line">            success : false,</span><br><span class="line">			type:&quot;hot_food_list&quot;,</span><br><span class="line">            data : []</span><br><span class="line">        &#125;;</span><br><span class="line">        if (this.food_info_list_size &lt;= hot_num) &#123;</span><br><span class="line">            for(var i = this.food_info_list_size - 1; i &gt;= 0 ; i--) &#123;</span><br><span class="line">                var food_info = this.food_info_list.get(this.food_info_list_array.get(i));</span><br><span class="line">                var out_info = &#123;</span><br><span class="line">                    food_name: food_info.food_name,</span><br><span class="line">                    food_summary: food_info.food_summary,</span><br><span class="line">                    image: food_info.image,</span><br><span class="line">                    like_num: food_info.like_num,</span><br><span class="line">                    comm_num: food_info.comm_num,</span><br><span class="line">                    food_info_key: food_info.food_info_key,</span><br><span class="line">                    name: food_info.name,</span><br><span class="line">                    time: food_info.time,</span><br><span class="line">                    food_type: food_info.food_type</span><br><span class="line">                &#125;;</span><br><span class="line">                var like_info = this._query_like_by_key(out_info.food_info_key).like;</span><br><span class="line">                if (&quot;&quot; != like_info) &#123;</span><br><span class="line">                   out_info.like_num = like_info.number;</span><br><span class="line">                &#125;</span><br><span class="line">                // 更新评论信息</span><br><span class="line">                var comment_num_info = this.query_comment_sum(out_info.food_info_key);</span><br><span class="line">                if (comment_num_info.success == true) &#123;</span><br><span class="line">                    out_info.comm_num = comment_num_info.sum;</span><br><span class="line">                &#125;</span><br><span class="line">                result.data.push(out_info);</span><br><span class="line">            &#125;</span><br><span class="line">            result.success = true;</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">        // 按照星星排序</span><br><span class="line">        var temp_hostest_food_key = [];</span><br><span class="line">        var last_temp_food_key = &quot;&quot;;</span><br><span class="line">        if(hot_num &lt; this.good_item_list_size) &#123;</span><br><span class="line">            // 查询</span><br><span class="line">            for(var i = 0; i &lt; hot_num; i++) &#123;</span><br><span class="line">                var good_key = this.good_item_list_array.get(this.good_item_list_size - 1);</span><br><span class="line">                var star_num = this.good_item_list.get(good_key).number;</span><br><span class="line">                var temp_food_key = this.good_item_list.get(good_key).food_info_key;</span><br><span class="line">                for(var j = this.good_item_list_size - 1; j &gt;= 0; j--) &#123;</span><br><span class="line">                    var cur_good_key = this.good_item_list_array.get(j);</span><br><span class="line">                    var cur_num = this.good_item_list.get(cur_good_key).number;</span><br><span class="line">                    var cur_food_key = this.good_item_list.get(cur_good_key).food_info_key;</span><br><span class="line">                    if (star_num &lt; cur_num &amp;&amp; last_temp_food_key != cur_food_key) &#123;</span><br><span class="line">                        star_num = cur_num;</span><br><span class="line">                        temp_food_key = cur_food_key;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                temp_hostest_food_key.push(temp_food_key);</span><br><span class="line">                last_temp_food_key = temp_food_key;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            //</span><br><span class="line">            for(var j = this.good_item_list_size - 1; j &gt;= 0; j--) &#123;</span><br><span class="line">                var cur_good_key = this.good_item_list_array.get(j);</span><br><span class="line">                var cur_food_key = this.good_item_list.get(cur_good_key).food_info_key;</span><br><span class="line">                temp_hostest_food_key.push(cur_food_key);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var need_num = (hot_num - this.good_item_list_size);</span><br><span class="line">            var index = 0;</span><br><span class="line">            for(var i = this.food_info_list_size - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">                var food_info = this.food_info_list.get(this.food_info_list_array.get(i));</span><br><span class="line">                var b_contain = this._array_contains(temp_hostest_food_key, food_info.food_info_key);</span><br><span class="line">                if (!b_contain) &#123;</span><br><span class="line">                    temp_hostest_food_key.push(food_info.food_info_key);</span><br><span class="line">                    index++;</span><br><span class="line">                &#125;</span><br><span class="line">                if (index &gt;= need_num) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // 获取key info</span><br><span class="line">        for(var i = 0; i &lt; temp_hostest_food_key.length; i++) &#123;</span><br><span class="line">            var cur_food = this.food_info_list.get(temp_hostest_food_key[i]);</span><br><span class="line">            var out_info = &#123;</span><br><span class="line">                food_name: cur_food.food_name,</span><br><span class="line">                food_summary: cur_food.food_summary,</span><br><span class="line">                image: cur_food.image,</span><br><span class="line">                like_num: cur_food.like_num,</span><br><span class="line">                comm_num: cur_food.comm_num,</span><br><span class="line">                food_info_key: cur_food.food_info_key,</span><br><span class="line">                name: cur_food.name,</span><br><span class="line">                time: cur_food.time,</span><br><span class="line">                food_type: cur_food.food_type</span><br><span class="line">            &#125;;</span><br><span class="line">            var like_info = this._query_like_by_key(out_info.food_info_key).like;</span><br><span class="line">            if (&quot;&quot; != like_info) &#123;</span><br><span class="line">                out_info.like_num = like_info.number;</span><br><span class="line">            &#125;</span><br><span class="line">            // 更新评论信息</span><br><span class="line">            var comment_num_info = this.query_comment_sum(out_info.food_info_key);</span><br><span class="line">            if (comment_num_info.success == true) &#123;</span><br><span class="line">                out_info.comm_num = comment_num_info.sum;</span><br><span class="line">            &#125;</span><br><span class="line">            result.data.push(out_info);</span><br><span class="line">        &#125;</span><br><span class="line">        result.success = true;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;,</span><br><span class="line">    query_food_list_by_page : function(searchKey,page)&#123;</span><br><span class="line">        var result = &#123;</span><br><span class="line">            success : false,</span><br><span class="line">            type:&quot;food_info_list&quot;,</span><br><span class="line">            data : [],</span><br><span class="line">            sum : 0</span><br><span class="line">        &#125;;</span><br><span class="line">        var pageNum=1;</span><br><span class="line">        var pageSize=10;</span><br><span class="line">        if(page!=undefined&amp;&amp;page!=null)&#123;</span><br><span class="line">            if(page.pageNum!=undefined&amp;&amp;page.pageNum!=null)&#123;</span><br><span class="line">                pageNum=page.pageNum;</span><br><span class="line">            &#125;</span><br><span class="line">            if(page.pageSize!=undefined&amp;&amp;page.pageSize!=null)&#123;</span><br><span class="line">                pageSize=page.pageSize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        var number = this.food_info_list_size;</span><br><span class="line">        result.sum = number;</span><br><span class="line">        var key;</span><br><span class="line">        var food_item;</span><br><span class="line">		var dataList=[];</span><br><span class="line">		for(var i=0;i&lt;number;i++)&#123;</span><br><span class="line">			key = this.food_info_list_array.get(i);</span><br><span class="line">            food_item = this.food_info_list.get(key);</span><br><span class="line">			var like=this._query_like_by_key(key).like;</span><br><span class="line">			if(&apos;&apos;!=like)&#123;</span><br><span class="line">				food_item.like_num=like.number;</span><br><span class="line">			&#125;else&#123;</span><br><span class="line">				food_item.like_num=0;</span><br><span class="line">			&#125;</span><br><span class="line">			var page=&#123;&quot;pageSize&quot;:90000000,&quot;pageNum&quot;:1&#125;;</span><br><span class="line">			var comm_list=this.query_comment_by_page(key,page).data;</span><br><span class="line">			food_item.comm_num=comm_list.length;</span><br><span class="line">			if(searchKey)&#123;</span><br><span class="line">				if(food_item)&#123;</span><br><span class="line">					if((food_item.food_name.indexOf(searchKey)!=-1)||(food_item.food_summary.indexOf(searchKey)!=-1)||(food_item.food_type.indexOf(searchKey)!=-1))&#123;</span><br><span class="line">                        var out_info = &#123;</span><br><span class="line">                            food_name: food_item.food_name,</span><br><span class="line">                            food_summary: food_item.food_summary,</span><br><span class="line">                            image: food_item.image,</span><br><span class="line">                            like_num: food_item.like_num,</span><br><span class="line">                            comm_num: food_item.comm_num,</span><br><span class="line">                            food_info_key: food_item.food_info_key,</span><br><span class="line">                            name: food_item.name,</span><br><span class="line">                            time: food_item.time,</span><br><span class="line">                            food_type: food_item.food_type</span><br><span class="line">                        &#125;;</span><br><span class="line">						dataList.push(out_info);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;else&#123;</span><br><span class="line">                var out_info = &#123;</span><br><span class="line">                    food_name: food_item.food_name,</span><br><span class="line">                    food_summary: food_item.food_summary,</span><br><span class="line">                    image: food_item.image,</span><br><span class="line">                    like_num: food_item.like_num,</span><br><span class="line">                    comm_num: food_item.comm_num,</span><br><span class="line">                    food_info_key: food_item.food_info_key,</span><br><span class="line">                    name: food_item.name,</span><br><span class="line">                    time: food_item.time,</span><br><span class="line">                    food_type: food_item.food_type</span><br><span class="line">                &#125;;</span><br><span class="line">                dataList.push(out_info);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		number=dataList.length;</span><br><span class="line">		dataList=dataList.reverse();</span><br><span class="line">        for(var i=(pageNum-1)*pageSize;i&lt;number&amp;&amp;i&lt;(pageNum*pageSize);i++)&#123;</span><br><span class="line">            food_item = dataList[i];</span><br><span class="line">			result.data.push(food_item);</span><br><span class="line">        &#125;</span><br><span class="line">        if(result.data === &quot;&quot;||result.data.length&lt;1)&#123;</span><br><span class="line">            result.success = false;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            result.success = true;</span><br><span class="line">        &#125;</span><br><span class="line">        return result;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后是必不可少的奖励机制：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">rewardOther: function(info) &#123;</span><br><span class="line">        // &#123;&quot;address&quot;:&quot;&quot;, key:&quot;&quot;&#125;</span><br><span class="line">        var fromUser = Blockchain.transaction.from,</span><br><span class="line">            value = Blockchain.transaction.value;</span><br><span class="line">        var food_info = this.food_info_list.get(info.key);</span><br><span class="line">        if (food_info) &#123;</span><br><span class="line">            var result = Blockchain.transfer(info.address, value);</span><br><span class="line">            return result</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;,</span><br></pre></td></tr></table></figure>
<h3 id="4-4-定义一些通用的API"><a href="#4-4-定义一些通用的API" class="headerlink" title="4.4 定义一些通用的API"></a>4.4 定义一些通用的API</h3><p>虽然nebulas的智能合约可以完全基于JS开发，但是它依然有自己独特的规则和语法糖，这一步是为了把JS中的JSON数据转换为符合规则的数据结构，并定义增删改查等基本操作的API、定义setter和getter处理器，定义storageMap对象和属性对象等等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 以CRUD操作为例</span><br><span class="line">StorageMap.prototype = &#123;</span><br><span class="line">    del: function (key) &#123;</span><br><span class="line">        return this.contractStorage.del(combineStorageMapKey(this.fieldName, key));</span><br><span class="line">    &#125;,</span><br><span class="line">    get: function (key) &#123;</span><br><span class="line">        var val = this.contractStorage.rawGet(combineStorageMapKey(this.fieldName, key));</span><br><span class="line">        if (val != null) &#123;</span><br><span class="line">            val = this.parse(val);</span><br><span class="line">        &#125;</span><br><span class="line">        return val;</span><br><span class="line">    &#125;,</span><br><span class="line">    set: function (key, value) &#123;</span><br><span class="line">        var val = this.stringify(value);</span><br><span class="line">        return this.contractStorage.rawSet(combineStorageMapKey(this.fieldName, key), val);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">StorageMap.prototype.put = StorageMap.prototype.set;</span><br><span class="line">StorageMap.prototype.delete = StorageMap.prototype.del;</span><br></pre></td></tr></table></figure>
<h3 id="4-5-部署智能合约"><a href="#4-5-部署智能合约" class="headerlink" title="4.5 部署智能合约"></a>4.5 部署智能合约</h3><p>首先要在Nebulas的github地址上下载一个web-wallet：<code>git clone https://github.com/nebulasio/web-wallet.git</code>。</p>
<p>打开web-wallet文件夹，并找到index.html，在浏览器中打开：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-27a672563348bead.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>选择刚才编写的智能合约，把代码粘贴到合约代码输入框中，并选择钱包文件，解锁，然后点击测试，或者直接提交，提交之后将在主网生成一个合约地址。</p>
<p>这就相当于部署了一个服务器，合约地址即为服务端接口地址：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-d2ba74c1d696a17d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>现在我们在ViewModel层就可以调用智能合约中的方法了，使用方式同样类似于JS里的Ajax：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">···</span><br><span class="line">var req_arg_item = &#123;</span><br><span class="line">      &quot;content&quot;: content,</span><br><span class="line">      &quot;id&quot;: food_name,</span><br><span class="line">      &quot;comment_time&quot;: comment_time,</span><br><span class="line">      &quot;food_info_key&quot;: self.food_info_key,</span><br><span class="line">      &quot;time_stamp&quot;: time_stamp</span><br><span class="line">&#125;;</span><br><span class="line">var req_args = [];</span><br><span class="line">req_args.push(req_arg_item);</span><br><span class="line">···</span><br><span class="line">window.postMessage(&#123;</span><br><span class="line">      &quot;target&quot;: &quot;contentscript&quot;,</span><br><span class="line">      &quot;data&quot;: &#123;</span><br><span class="line">        &quot;to&quot;: dappAddress,</span><br><span class="line">        &quot;value&quot;: &quot;0&quot;,</span><br><span class="line">        &quot;contract&quot;: &#123;</span><br><span class="line">          &quot;function&quot;: func,</span><br><span class="line">          &quot;args&quot;: JSON.stringify(req_args),</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;method&quot;: &quot;neb_sendTransaction&quot;</span><br><span class="line">&#125;, &quot;*&quot;);</span><br><span class="line"></span><br><span class="line">···</span><br></pre></td></tr></table></figure>
<h2 id="5-系统运行"><a href="#5-系统运行" class="headerlink" title="5 系统运行"></a>5 系统运行</h2><h3 id="5-1-首页"><a href="#5-1-首页" class="headerlink" title="5.1 首页"></a>5.1 首页</h3><p>首页的最上方是页面导航，banner区域是一组轮播图，正文区域显示的是按照点赞数排序的一组美食信息缩略图。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-74e9c8796bcc7a75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="5-2-查看菜谱详情"><a href="#5-2-查看菜谱详情" class="headerlink" title="5.2 查看菜谱详情"></a>5.2 查看菜谱详情</h3><p>详情页面能看到菜谱的信息，配料，制作过程，以及评论和点赞信息，同时也可以再页面底部的评论框中发表评论。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-0d3fd90bdbcd2393.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="5-3-打赏"><a href="#5-3-打赏" class="headerlink" title="5.3 打赏"></a>5.3 打赏</h3><p>点击打赏，将跳出Nebulas钱包插件的交易窗口。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-6451ec8a60de4474.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>根据网络情况，选择合适的Gas Limit和Gas Price作为矿工费，并填写想要打赏的金额，它将调用智能合约里的rewardOther方法，这笔金额将直接发送到菜谱作者的钱包地址里。</p>
<h3 id="5-4-发布菜谱"><a href="#5-4-发布菜谱" class="headerlink" title="5.4 发布菜谱"></a>5.4 发布菜谱</h3><p>填写菜谱信息和过程，可以增加多种配料和步骤。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-69a145c9e6fa0edf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>该过程由于涉及到上链，所以在点击提交之后，同样会跳出Nebulas交易窗口。要发送的金额输入框不需要填写数额，为0即可，但是需要为星云网络支付一定数目的矿工费，也就是Gas，Gas费的多少会决定上传速度的快慢，Gas费支付得越多，矿工打包上链的速度则越快。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/3396508-e06ea2b14a03811d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h3 id="5-5-使用攻略"><a href="#5-5-使用攻略" class="headerlink" title="5.5 使用攻略"></a>5.5 使用攻略</h3><p><img src="https://upload-images.jianshu.io/upload_images/3396508-7753d550da9192d8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>从最开始确定要研究区块链方向的Dapp，到这个应用的整体完成，我从中学到了很多知识，不仅仅是编程方法，还有一些伟大的哲学思想，从拜占庭将军问题到不可能三角，从POW到POS，从DOPS到有向无环图，每个共识机制的诞生都是一次伟大的社会实验，冲击着我们现有的认知和体系。我清楚的看到，这个世界上有许多走在时代之前的人，他们正在开拓未来，并向旧时代发起挑战。这是一件让人感到兴奋的事，让我从中积累了一大笔财富，引领我向更深刻的问题思考。</p>
<p>虽然这个系统还不是很成熟，Nebulas也从开始的风光无限到了目前风雨飘摇的境地，但我依然可以很自豪的说，我很认真的写完了每一行代码，我做了一个正确的选择。</p>
<p>系统不足：目前网站的规模还很小，Nebulas主网的共识程度低，性能也遭遇了一定的瓶颈，这无疑是不利于网站未来建设的。</p>
<h2 id="致谢"><a href="#致谢" class="headerlink" title="致谢"></a>致谢</h2><h3 id="A-Guide-to-99-Fault-Tolerant-Consensus（excerpt）"><a href="#A-Guide-to-99-Fault-Tolerant-Consensus（excerpt）" class="headerlink" title="A Guide to 99% Fault Tolerant Consensus（excerpt）"></a>A Guide to 99% Fault Tolerant Consensus（excerpt）</h3><p>We’ve heard for a long time that it’s possible to achieve consensus with 50% fault tolerance in a synchronous network where messages broadcasted by any honest node are guaranteed to be received by all other honest nodes within some known time period (if an attacker has more than 50%, they can perform a “51% attack”, and there’s an analogue of this for any algorithm of this type). We’ve also heard for a long time that if you want to relax the synchrony assumption, and have an algorithm that’s “safe under asynchrony”, the maximum achievable fault tolerance drops to 33% (PBFT, Casper FFG, etc all fall into this category). But did you know that if you add even more assumptions (specifically, you require observers, ie. users that are not actively participating in the consensus but care about its output, to also be actively watching the consensus, and not just downloading its output after the fact), you can increase fault tolerance all the way to 99%?</p>
<p>This has in fact been known for a long time; Leslie Lamport’s famous 1982 paper “The Byzantine Generals Problem” (link here) contains a description of the algorithm. The following will be my attempt to describe and reformulate the algorithm in a simplified form.</p>
<p>Suppose that there are N consensus-participating nodes, and everyone agrees who these nodes are ahead of time (depending on context, they could have been selected by a trusted party or, if stronger decentralization is desired, by some proof of work or proof of stake scheme). We label these nodes 0….N-1. Suppose also that there is a known bound D on network latency plus clock disparity (eg. D = 8 seconds). Each node has the ability to publish a value at time T (a malicious node can of course propose values earlier or later than T). All nodes wait (N-1) * D seconds, running the following process. Define x : i as “the value x signed by node i”, x : i : j as “the value x signed by i, and that value and signature together signed by j”, etc. The proposals published in the first stage will be of the form v: i for some v and i, containing the signature of the node that proposed it.</p>
<p>If a validator i receives some message v : i[1] : … : i[k], where i[1] … i[k] is a list of indices that have (sequentially) signed the message already (just v by itself would count as k=0, and v:i as k=1), then the validator checks that (i) the time is less than T + k * D, and (ii) they have not yet seen a valid message containing v; if both checks pass, they publish v : i[1] : … : i[k] : i.</p>
<p>At time T + (N-1) * D, nodes stop listening. At this point, there is a guarantee that honest nodes have all “validly seen” the same set of values.</p>
<p><img src="https://vitalik.ca/files/Lamport.png" alt=""></p>
<p><em>Node 1 (red) is malicious, and nodes 0 and 2 (grey) are honest. At the start, the two honest nodes make their proposals y and x, and the attacker proposes both w and z late. w reaches node 0 on time but not node 2, and z reaches neither node on time. At time T + D, nodes 0 and 2 rebroadcast all values they’ve seen that they have not yet broadcasted, but add their signatures on (x and w for node 0, y for node 2). Both honest nodes saw {x, y, w}.</em></p>
<p>If the problem demands choosing one value, they can use some “choice” function to pick a single value out of the values they have seen (eg. they take the one with the lowest hash). The nodes can then agree on this value.</p>
<p>Now, let’s explore why this works. What we need to prove is that if one honest node has seen a particular value (validly), then every other honest node has also seen that value (and if we prove this, then we know that all honest nodes have seen the same set of values, and so if all honest nodes are running the same choice function, they will choose the same value). Suppose that any honest node receives a message v : i[1] : … : i[k] that they perceive to be valid (ie. it arrives before time T + k * D). Suppose x is the index of a single other honest node. Either x is part of {i[1] … i[k]} or it is not.</p>
<ul>
<li>In the first case (say x = i[j] for this message), we know that the honest node x had already broadcasted that message, and they did so in response to a message with j-1 signatures that they received before time T + (j-1) <em> D, so they broadcast their message at that time, and so the message must have been received by all honest nodes before time T + j </em> D.</li>
<li>In the second case, since the honest node sees the message before time T + k <em> D, then they will broadcast the message with their signature and guarantee that everyone, including x, will see it before time T + (k+1) </em> D.</li>
</ul>
<p>Notice that the algorithm uses the act of adding one’s own signature as a kind of “bump” on the timeout of a message, and it’s this ability that guarantees that if one honest node saw a message on time, they can ensure that everyone else sees the message on time as well, as the definition of “on time” increments by more than network latency with every added signature.</p>
<p>In the case where one node is honest, can we guarantee that passive observers (ie. non-consensus-participating nodes that care about knowing the outcome) can also see the outcome, even if we require them to be watching the process the whole time? With the scheme as written, there’s a problem. Suppose that a commander and some subset of k (malicious) validators produce a message v : i[1] : …. : i[k], and broadcast it directly to some “victims” just before time T + k <em> D. The victims see the message as being “on time”, but when they rebroadcast it, it only reaches all honest consensus-participating nodes after T + k </em> D, and so all honest consensus-participating nodes reject it.</p>
<p><img src="http://vitalik.ca/files/Lamport2.png" alt=""></p>
<p>But we can plug this hole. We require D to be a bound on two times network latency plus clock disparity. We then put a different timeout on observers: an observer accepts v : i[1] : …. : i[k] before time T + (k - 0.5) <em> D. Now, suppose an observer sees a message an accepts it. They will be able to broadcast it to an honest node before time T + k </em> D, and the honest node will issue the message with their signature attached, which will reach all other observers before time T + (k + 0.5) * D, the timeout for messages with k+1 signatures.</p>
<p><img src="http://vitalik.ca/files/Lamport3.png" alt=""></p>
<p><strong>中文部分</strong></p>
<h3 id="99-容错共识算法（节选）"><a href="#99-容错共识算法（节选）" class="headerlink" title="99%容错共识算法（节选）"></a>99%容错共识算法（节选）</h3><p>作者：维塔利克·布特林</p>
<p>很长时间以来，我们都听说过在同步网络中有可能实现50%容错共识，其中通过任何诚实节点广播的消息保证能够在某个已知时段内被所有其他诚实节点收到（如果攻击者拥有超过50%的节点，他们能够实施“51%攻击”，对于任何此类的算法来说，都有类似的情况）。</p>
<p>我们也一直听说，如果您希望放宽同步假设，并有个“在异步下安全”的算法，那么最大可实现的容错率下降到33%（PBFT，Casper FFG等都属于这一类）。但是，如果增加更多的假设（具体来说，需要观察者也积极地观察共识，并且不只是事后才下载它的输出），就能够将容错率一直提高到99%。</p>
<p>事实上，这早已为人所知，Leslie Lamport写于1982年的著名论文《拜占庭将军问题》描述了该算法。下面是我尝试用简化的形式描述和重构该算法。</p>
<p>假设有N个节点，我们分别用0，……，N-1来标识，并且在网络延迟加上时钟差异有个已知的界限D（比如，D = 8 秒）。每个节点具有在时间T（恶意节点当然能够早于或晚于时间T）发布一个值的能力。所有节点等待(N - 1) * D秒，运行以下过程。定义 x : i是“节点i签署的值x”，x : i : j 是“节点i签署的值x，并且由节点j签署该值和签名”，等等。在第一个阶段发布的提议以v : i的形式出现，代表某些v和i，包含提出它的节点的签名。</p>
<p>如果验证节点i收到一些消息 v : i[1] : … : i[k]，其中 i[k]是一个索引列表，这些索引已经（顺序）签署了消息（只是v本身将计为 k = 0，并且 v:i计为 k = 1），然后，验证器检查（i）时间是否小于 T + K * D，以及（ii）它们是否还没看到一个有效的包含v的消息。如果这两个验证都通过，那么，它们就发布 v : i[1] : … : i[k] : i。</p>
<p>在 T + (N-1) * D时刻，节点停止侦听，它们使用一些“选择”功能从所有它们已经看到的有效消息中选择一个值（比如，它们取最高的）。然后，它们决定这个值。</p>
<p><img src="http://vitalik.ca/files/Lamport.png" alt=""></p>
<p><em>节点1（红色）是恶意节点，而节点0和节点2（灰色）是诚实节点。一开始，这两个诚实节点给出它们的提议 y 和 x，攻击者晚提出w和 z，w准时到达节点0，但是没能准时到达节点2，z既没有准时到达节点0，也没有准时到达节点2。在 T + D时刻，节点0和节点2重新广播了它们看到但还没有广播过的所有值，并在上面添加了它们的签名（x和 w用于节点0，y用于节点2）。两个诚实节点都看到了{x，y，w}，然后，它们可以使用一些标准选择函数（即，按字母顺序，最高的：y）。</em></p>
<p>现在，我们来探究一下这个为什么可行。我们需要证明的是，如果一个诚实节点已经看到一个特定值（有效的），然后，其他各个诚实节点也看到了该值（如果我们能证明这个，那么我们就知道所有的诚实节点在运行同样的选择函数，因此它们会输出相同的值）。假设任意一个诚实节点收到消息v : i[1] : … : i[k]，它们认为有效（即，它在 T + k * D时刻前到达）。 假设x是单个其他诚实节点的索引。那么，x要么是{i[1] … i[k]}的一部分，要么不是。</p>
<ul>
<li>在第一种情况下（设 x = i[j] 是这个消息），我们知道，诚实节点 x 已经广播了该消息，并且它们这么做是为了响应用在 T+ (j - 1)<em>D时刻前收到的带有j – 1个签名的消息，于是，它们在那个时刻广播了它们的消息，因此，在T+ j </em> D时刻前，所有诚实节点应该收到了该消息。</li>
<li>在第二种情况下，由于诚实节点在T + k <em> D时刻前看到了该消息，然后，它们将广播带着它们签名的数据，并保证包括x在内的每个节点都会在 T + (k+1) </em> D时刻前看到该消息。</li>
</ul>
<p>注意，该算法使用添加自己签名的操作，作为一种在超时消息上的“撞击”，并且这种能力保证，如果一个诚实节点看到准时的消息，它们可以确保其他任何节点也能准时看到该消息，因为“准时”的定义随着每个增加的签名而增加更多的网络延时。</p>
<p>在这种情况下，如果一个节点是诚实的，我们能否保证被动观察者也能够看到输出，就算我们要求它们一直观察过程？按照所写的计划，存在一个问题。假设命令者和一些k（恶意）验证器子集产生了一个消息 v : i[1] : … : i[k]，并且在 T + k <em> D时刻前，直接把它广播给了一些“受害者”。这些受害者认为该消息是准时的，但是，当它们重新广播该消息时，它只在 T + k </em> D时刻后到达所有诚实参与共识的节点，因此，所有诚实参与共识的节点都会拒绝该消息。</p>
<p><img src="https://res.infoq.com/articles/vitalik-buterin-proposes-consensus-algorithm/zh/resources/6272-1535217006997.png" alt=""></p>
<p>但是，我们可以补上这个漏洞。我们要求D受两倍网络时延加上时钟差异的约束。然后，我们对观察者施加不同的超时：观察者在 T + (k – 0.5) <em> D时刻前收到 v : i[1] : … : i[k]。现在，假设观察者看到一个消息并接收它。它们将能够在 T + k </em> D时刻前广播给一个诚实节点，并且诚实节点会发出附有其签名的消息，该消息将在 T + (k + 0.5) * D时刻前达到所有其他观察者，那么，具有 k+1个签名的消息超时。</p>
<p><img src="https://res.infoq.com/articles/vitalik-buterin-proposes-consensus-algorithm/zh/resources/5173-1535217007241.png" alt=""></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/毕业论文/" rel="tag"># 毕业论文</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/asynchronous/" rel="next" title="用Callbacks Promises 和 Async/Await写一段异步代码">
                <i class="fa fa-chevron-left"></i> 用Callbacks Promises 和 Async/Await写一段异步代码
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/uploads/012.jpeg"
                alt="断桥百晓生" />
            
              <p class="site-author-name" itemprop="name">断桥百晓生</p>
              <p class="site-description motion-element" itemprop="description">野马也，尘埃也。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-绪论"><span class="nav-number">1.</span> <span class="nav-text">1. 绪论</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-研究目的"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 研究目的</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-发展历程"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 发展历程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-开发工具的选择"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 开发工具的选择</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-1-IDE选择"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.3.1 IDE选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-2-操作系统选择"><span class="nav-number">1.3.2.</span> <span class="nav-text">1.3.2 操作系统选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-3-Web容器选择"><span class="nav-number">1.3.3.</span> <span class="nav-text">1.3.3 Web容器选择</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-4-数据库"><span class="nav-number">1.3.4.</span> <span class="nav-text">1.3.4 数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-3-5-编程框架"><span class="nav-number">1.3.5.</span> <span class="nav-text">1.3.5 编程框架</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-系统分析"><span class="nav-number">2.</span> <span class="nav-text">2. 系统分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-主要功能"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 主要功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-方案论证"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 方案论证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-基本思路"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 基本思路</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-1-网站UI的思路"><span class="nav-number">2.3.1.</span> <span class="nav-text">2.3.1 网站UI的思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-2-获取数据的思路"><span class="nav-number">2.3.2.</span> <span class="nav-text">2.3.2 获取数据的思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-3-3-权限控制思路"><span class="nav-number">2.3.3.</span> <span class="nav-text">2.3.3 权限控制思路</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-主要问题"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 主要问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-5-网站要求"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 网站要求</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-系统设计"><span class="nav-number">3.</span> <span class="nav-text">3 系统设计</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-概要设计"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 概要设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-1-系统结构图"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.1.1 系统结构图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-1-2-数据表结构图"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.1.2  数据表结构图</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-系统实现"><span class="nav-number">4.</span> <span class="nav-text">4 系统实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-创建系统外观界面"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 创建系统外观界面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-构建一个事件模型"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 构建一个事件模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-智能合约的实现"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 智能合约的实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-4-定义一些通用的API"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 定义一些通用的API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-5-部署智能合约"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 部署智能合约</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-系统运行"><span class="nav-number">5.</span> <span class="nav-text">5 系统运行</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-首页"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 首页</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-查看菜谱详情"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 查看菜谱详情</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-3-打赏"><span class="nav-number">5.3.</span> <span class="nav-text">5.3 打赏</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-4-发布菜谱"><span class="nav-number">5.4.</span> <span class="nav-text">5.4 发布菜谱</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-5-使用攻略"><span class="nav-number">5.5.</span> <span class="nav-text">5.5 使用攻略</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">6.</span> <span class="nav-text">结束语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#致谢"><span class="nav-number">7.</span> <span class="nav-text">致谢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-Guide-to-99-Fault-Tolerant-Consensus（excerpt）"><span class="nav-number">7.1.</span> <span class="nav-text">A Guide to 99% Fault Tolerant Consensus（excerpt）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#99-容错共识算法（节选）"><span class="nav-number">7.2.</span> <span class="nav-text">99%容错共识算法（节选）</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 &mdash; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">断桥百晓生</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  




  
  
  
  <link rel="stylesheet" href="/lib/algolia-instant-search/instantsearch.min.css">

  
  
  <script src="/lib/algolia-instant-search/instantsearch.min.js"></script>
  

  <script src="/js/src/algolia-search.js?v=5.1.4"></script>



  

  

  

  
  

  

  

  

</body>
</html>
